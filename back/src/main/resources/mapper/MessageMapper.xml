<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.heeexy.example.dao.MessageDao">
    <select id="getAllMessage" resultType="com.alibaba.fastjson.JSONObject">
        SELECT m.message_id, m.chat_id, m.message_content, m.message_time, m.status
        FROM lc_message m
    </select>
    
    <select id="getMessage" resultType="com.alibaba.fastjson.JSONObject">
        SELECT m.message_id, m.chat_id, m.message_content, m.message_time, m.status
        FROM lc_message m
        WHERE m.status = #{status}
    </select>

    <select id="getMessageByUserId" resultType="com.alibaba.fastjson.JSONObject">
        SELECT m.message_id, m.chat_id, m.message_content, m.message_time, m.status, c.another_id
        FROM lc_message m, lc_chat c
        WHERE m.status > -1 AND m.chat_id = c.chat_id AND c.user_id = #{id} OR c.another_id = #{id}
        GROUP BY m.chat_id
        ORDER BY m.message_time DESC
    </select>

    <select id="getMessageByChatId" resultType="com.alibaba.fastjson.JSONObject">
        SELECT m.message_id, m.chat_id, m.message_content, m.message_time, m.status
        FROM lc_message m
        WHERE m.status > -1 AND m.chat_id = #{chatid}
        ORDER BY m.message_time DESC
    </select>

    <select id="getPictureByMessageId" resultType="com.alibaba.fastjson.JSONObject">
        SELECT p.picture_id, p.message_id, p.picture_path
        FROM lc_message_pic p
        WHERE p.message_id = #{id}
        ORDER BY p.picture_id
    </select>

    <select id="countUnreadMessage" resultType="int">
        SELECT COUNT(0)
        FROM lc_message m
        WHERE m.status = 0 AND m.chat_id = #{id}
    </select>

    <select id="getChatId" resultType="int">
        SELECT c.chat_id
        FROM lc_chat c
        WHERE (c.user_id = #{fuid} AND c.another_id = #{tuid}) OR (c.user_id = #{tuid} AND c.another_id = #{fuid})
    </select>

    <select id="countChatId" resultType="int">
        SELECT COUNT(0)
        FROM lc_chat c
        WHERE (c.user_id = #{fuid} AND c.another_id = #{tuid}) OR (c.user_id = #{tuid} AND c.another_id = #{fuid})
    </select>

    <insert id="addChat" parameterType="com.alibaba.fastjson.JSONObject">
        INSERT INTO lc_chat
        (user_id, another_id)
        VALUES
        (#{fuid}, #{tuid})
    </insert>

    <insert id="addMessage" parameterType="com.alibaba.fastjson.JSONObject">
        INSERT INTO lc_message
        (chat_id, message_content)
        VALUES
        (#{id}, #{content})
    </insert>

    <insert id="addPicture" parameterType="com.alibaba.fastjson.JSONObject">
        INSERT INTO lc_message_pic
        (message_id, picture_path)
        VALUES
        (#{mid}, #{path})
    </insert>
    
    <update id="removeMessage" parameterType="com.alibaba.fastjson.JSONObject">
        UPDATE lc_message
        SET status = -1
        WHERE message_id = #{id}
    </update>

</mapper>