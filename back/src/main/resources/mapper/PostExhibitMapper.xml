<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.heeexy.example.dao.PostExhibitDao">

    <resultMap id="postMap" type="com.heeexy.example.util.model.One2Many">
        <id column="postId" property="postId"/>
        <result column="ownerId" property="ownerId"/>
        <result column="ownerName" property="ownerName"/>
        <result column="postTime" property="postTime"/>
        <result column="postLocation" property="postLocation"/>
        <result column="postContent" property="postContent"/>
        <result column="sortName" property="sortName"/>
        <result column="priceLow" property="priceLow"/>
        <result column="priceHigh" property="priceHigh"/>
        <result column="alike" property="amountLike"/>
        <result column="acollect" property="amountCollect"/>
        <result column="aview" property="amountView"/>
        <collection property="imgList" ofType="String">
            <id column="imgAddress" property="imgAddress"/>
        </collection>
    </resultMap>
    <select id="getTopPost" resultMap="postMap">
        SELECT
        op.*,
        img                                      imgAddress,
        (SELECT COUNT(0) FROM fly_like l WHERE l.post_id=op.postId and l.like_state=1)+likeOff alike,
        (SELECT COUNT(0) FROM cqy_post_collect pc WHERE pc.post_id=op.postId and pc.display=1)+collectOff acollect,
        (SELECT COUNT(0) FROM fly_browse b WHERE b.post_id=op.postId)+viewOff aview
         from(
                 SELECT
                     id                                      postId,
                     post_owner                              ownerId,
                     user_name                               ownerName,
                     DATE_FORMAT(post_time, '%Y.%m.%d %T')   postTime,
                     post_location                           postLocation,
                     post_content                            postContent,
                     categories_name                         sortName,
                     price_low                               priceLow,
                     price_high                              priceHigh,
					 like_offset  							 likeOff,
					 collect_offset					         collectOff,
                     view_offset			                 viewOff
                 FROM tyn_post,fly_user,cqy_post_categories,tyn_post_tag
                 <where>
                     delete_state =1  and user_id=post_owner and categories_id=post_sort
                     <if test="isTop!= null and isTop != ''">
                         and is_top like #{isTop}
                     </if>
                     <if test="tagType!=null and tagType!='' ">
                         and id=post_id and tag_type=#{tagTtpe}
                     </if>
                 </where>
                 LIMIT #{offSet}, #{pageRow}
             ) op
             left join tyn_post_img tpi on postId=tpi.post_id
             ORDER BY postTime Desc
    </select>
    <select id="getNormalPost" resultMap="postMap">
        SELECT
        op.*,
        img                                      imgAddress,
        (SELECT COUNT(0) FROM fly_like l WHERE l.post_id=op.postId and l.like_state=1)+likeOff alike,
        (SELECT COUNT(0) FROM cqy_post_collect pc WHERE pc.post_id=op.postId and pc.display=1)+collectOff acollect,
        (SELECT COUNT(0) FROM fly_browse b WHERE b.post_id=op.postId)+viewOff aview
        from(
        SELECT
        id                                      postId,
        post_owner                              ownerId,
        user_name                               ownerName,
        DATE_FORMAT(post_time, '%Y.%m.%d %T')   postTime,
        post_location                           postLocation,
        post_content                            postContent,
        categories_name                         sortName,
        like_offset  							likeOff,
        collect_offset					        collectOff,
        view_offset			                    viewOff
        FROM tyn_post,fly_user,cqy_post_categories,tyn_post_tag
        <where>
            delete_state =1  and user_id=post_owner and categories_id=post_sort
            <if test="isTop!= null and isTop != ''">
                and is_top not like #{isTop}
            </if>
            <if test="tagType!=null and tagType!='' ">
                and id=post_id and tag_type=#{tagTtpe}
            </if>
        </where>
        LIMIT #{offSet}, #{pageRow}
        ) op
        left join tyn_post_img tpi on postId=tpi.post_id
        ORDER BY postTime Desc
    </select>

    <update id="updatePostState">
        UPDATE tyn_post
        SET
        delete_state = #{deleteState}
        WHERE id = #{postId}
    </update>
    <resultMap id="postDetailMap" type="com.heeexy.example.util.model.One2Many">
        <id column="postId" property="postId"/>
        <result column="ownerId" property="ownerId"/>
        <result column="ownerName" property="ownerName"/>
        <result column="postTime" property="postTime"/>
        <result column="sortId" property="sortId"/>
        <result column="sortName" property="sortName"/>
        <result column="postContent" property="postContent"/>
        <result column="postLocation" property="postLocation"/>
        <result column="postPhone" property="postPhone"/>
        <result column="priceLow" property="priceLow"/>
        <result column="priceHigh" property="priceHigh"/>
        <result column="timeStart" property="timeStart"/>
        <result column="timeEnd" property="timeEnd"/>
        <result column="isTop" property="isTop"/>
        <result column="likeOff" property="likeOff"/>
        <result column="collectOff" property="collectOff"/>
        <result column="viewOff" property="viewOff"/>
        <collection property="tagList" ofType="String">
            <id column="tagName" property="tagName"/>
        </collection>
        <collection property="imgList" ofType="String">
            <id column="imgName" property="imgName"/>
        </collection>
    </resultMap>
    <select id="queryOnePost" resultMap="postDetailMap">
           SELECT
            p.*,
            bs.business_subway_name                            tagName,
            pi.img                                             imgName
        FROM (
                 SELECT
                     id                                      postId,
                     post_owner                              ownerId,
                     user_name                               ownerName,
                     DATE_FORMAT(post_time, '%Y.%m.%d %T')   postTime,
                     post_sort                               sortId,
                     categories_name                         sortName,
                     post_content                            postContent,
                     post_location                           postLocation,
                     post_phone                              postPhone,
                     price_low                               priceLow,
                     price_high                              priceHigh,
                     time_start                              timeStart,
                     time_end                                timeEnd,
                     is_top                                  isTop,
					 like_offset  							 likeOff,
					 collect_offset					         collectOff,
                     view_offset			                 viewOff
                 FROM tyn_post,fly_user,cqy_post_categories
                 WHERE id=#{postId} and user_id=post_owner and categories_id=post_sort
             ) p
            LEFT JOIN tyn_post_tag pt ON p.postId=pt.post_id
            left join cqy_business_subway bs on pt.tag_id=bs.business_subway_id
            left join tyn_post_img pi on pi.post_id=p.postId

    </select>
    <select id="getAllSorts" resultType="com.alibaba.fastjson.JSONObject">
        SELECT
            categories_id        sortId,
            categories_name      sortName
        FROM cqy_post_categories
        WHERE display=1
    </select>

    <update id="updatePost">
        update  tyn_post
        set
        post_sort= #{sortId},
        post_content= #{postContent},
        like_offset= #{likeOff},
        collect_offset= #{collectOff},
        view_offset= #{viewOff}
        where
        id= #{postId}
    </update>
    <update id="updatePostTop">
        UPDATE tyn_post
        SET
        is_top = #{isTop}
        WHERE id = #{postId}
    </update>
    
    <select id="getSomeTag"   resultType="com.alibaba.fastjson.JSONObject">
        select
        business_subway_id    tagId,
        business_subway_name  tagName
        from cqy_business_subway c
        where  c.superior_id = (
        select business_subway_id
        from cqy_business_subway c
        where c.business_subway_name = #{need}
        )
    </select>

    <select id="getNewTagId"   resultType="com.alibaba.fastjson.JSONObject">
        select business_subway_id tId,
        superior_id fId
        from cqy_business_subway
        <where>
            <foreach collection="newTag" item="name" open="business_subway_name in(" close=")" separator=",">
                #{name}
            </foreach>
        </where>
    </select>

    <insert id="addPostTag">
        insert into tyn_post_tag
        (post_id,tag_id,tag_type)
        values
        (#{postId},#{tId},(SELECT superior_id FROM cqy_business_subway WHERE business_subway_id = #{fId}))
    </insert>

    <select id="getDeleteTagId"   resultType="java.lang.Integer">
        select
        business_subway_id tId
        from cqy_business_subway
        <where>
            <foreach collection="deleteTag" item="name" open="business_subway_name in(" close=")" separator=",">
                #{name}
            </foreach>
        </where>
    </select>

    <delete id="deleteTag">
        delete from tyn_post_tag
        where tag_id=#{tId} and post_id=#{postId}
    </delete>

    <select id="getFirstTag" resultType="com.alibaba.fastjson.JSONObject">
        select
        business_subway_name tagName
        from cqy_business_subway
        where superior_id =0
     </select>

    <delete id="deleteImg">
        delete from tyn_post_img
        where img=#{img} and post_id=#{postId}
    </delete>
</mapper>